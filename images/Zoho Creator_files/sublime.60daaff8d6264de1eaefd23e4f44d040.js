(function(n){"object"==typeof exports&&"object"==typeof module?n(require("../../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],n):n(CodeMirror)})(function(n){function t(a,b){a.extendSelectionsBy(function(d){if(a.display.shift||a.doc.extend||d.empty()){var f=a.doc;d=d.head;if(0>b&&0==d.ch)var m=f.clipPos(l(d.line-1));else{var c=
f.getLine(d.line);if(0<b&&d.ch>=c.length)m=f.clipPos(l(d.line+1,0));else{f="start";for(var h=d.ch,e=0>b?0:c.length,g=0;h!=e;h+=b,g++){var k=c.charAt(0>b?h-1:h),p="_"!=k&&n.isWordChar(k)?"w":"o";"w"==p&&k.toUpperCase()==k&&(p="W");if("start"==f)"o"!=p&&(f="in",m=p);else if("in"==f&&m!=p)if("w"==m&&"W"==p&&0>b&&h--,"W"==m&&"w"==p&&0<b)m="w";else break}m=l(d.line,h)}}return m}return 0>b?d.from():d.to()})}function u(a,b){if(a.isReadOnly())return n.Pass;a.operation(function(){for(var d=a.listSelections().length,
f=[],m=-1,c=0;c<d;c++){var h=a.listSelections()[c].head;h.line<=m||(m=l(h.line+(b?0:1),0),a.replaceRange("\n",m,null,"+insertLine"),a.indentLine(m.line,null,!0),f.push({head:m,anchor:m}),m=h.line+1)}a.setSelections(f)});a.execCommand("indentAuto")}function r(a,b){var d=b.ch,f=d;for(a=a.getLine(b.line);d&&n.isWordChar(a.charAt(d-1));)--d;for(;f<a.length&&n.isWordChar(a.charAt(f));)++f;return{from:l(b.line,d),to:l(b.line,f),word:a.slice(d,f)}}function v(a){var b=a.getCursor(),d=a.scanForBracket(b,-1);
if(d)for(;;){b=a.scanForBracket(b,1);if(!b)break;if(b.ch=="(){}[]".charAt("(){}[]".indexOf(d.ch)+1))return a.setSelection(l(d.pos.line,d.pos.ch+1),b.pos,!1),!0;b=l(b.pos.line,b.pos.ch+1)}}function w(a,b){if(a.isReadOnly())return n.Pass;for(var d=a.listSelections(),f=[],m,c=0;c<d.length;c++){var h=d[c];if(!h.empty()){for(var e=h.from().line,g=h.to().line;c<d.length-1&&d[c+1].from().line==g;)g=h[++c].to().line;f.push(e,g)}}f.length?m=!0:f.push(a.firstLine(),a.lastLine());a.operation(function(){function d(a,
b){var d=a.toUpperCase(),f=b.toUpperCase();d!=f&&(a=d,b=f);return a<b?-1:a==b?0:1}for(var c=[],h=0;h<f.length;h+=2){var e=f[h+1],g=l(f[h],0);e=l(e);var q=a.getRange(g,e,!1);b?q.sort():q.sort(d);a.replaceRange(q,g,e);m&&c.push({anchor:g,head:e})}m&&a.setSelections(c,0)})}function x(a,b){a.operation(function(){for(var d=a.listSelections(),f=[],c=[],e=0;e<d.length;e++){var h=d[e];h.empty()?(f.push(e),c.push("")):c.push(b(a.getRange(h.from(),h.to())))}a.replaceSelections(c,"around","case");e=f.length-
1;for(var g;0<=e;e--)h=d[f[e]],g&&0<n.cmpPos(h.head,g)||(c=r(a,h.head),g=c.from,a.replaceRange(b(c.word),c.from,c.to))})}function y(a){var b=a.getCursor("from"),d=a.getCursor("to");if(0==n.cmpPos(b,d)){var f=r(a,b);if(!f.word)return;b=f.from;d=f.to}return{from:b,to:d,query:a.getRange(b,d),word:f}}function z(a,b){var d=y(a);if(d){var f=d.query,c=a.getSearchCursor(f,b?d.to:d.from);(b?c.findNext():c.findPrevious())?a.setSelection(c.from(),c.to()):(c=a.getSearchCursor(f,b?l(a.firstLine(),0):a.clipPos(l(a.lastLine()))),
(b?c.findNext():c.findPrevious())?a.setSelection(c.from(),c.to()):d.word&&a.setSelection(d.from,d.to))}}var c=n.keyMap.sublime={fallthrough:"default"},e=n.commands,l=n.Pos,k=n.keyMap["default"]==n.keyMap.macDefault,g=k?"Cmd-":"Ctrl-";e[c["Alt-Left"]="goSubwordLeft"]=function(a){t(a,-1)};e[c["Alt-Right"]="goSubwordRight"]=function(a){t(a,1)};k&&(c["Cmd-Left"]="goLineStartSmart");var A=k?"Ctrl-Alt-":"Ctrl-";e[c[A+"Up"]="scrollLineUp"]=function(a){var b=a.getScrollInfo();if(!a.somethingSelected()){var d=
a.lineAtHeight(b.top+b.clientHeight,"local");a.getCursor().line>=d&&a.execCommand("goLineUp")}a.scrollTo(null,b.top-a.defaultTextHeight())};e[c[A+"Down"]="scrollLineDown"]=function(a){var b=a.getScrollInfo();if(!a.somethingSelected()){var d=a.lineAtHeight(b.top,"local")+1;a.getCursor().line<=d&&a.execCommand("goLineDown")}a.scrollTo(null,b.top+a.defaultTextHeight())};e[c["Shift-"+g+"L"]="splitSelectionByLine"]=function(a){for(var b=a.listSelections(),d=[],f=0;f<b.length;f++)for(var c=b[f].from(),
e=b[f].to(),h=c.line;h<=e.line;++h)e.line>c.line&&h==e.line&&0==e.ch||d.push({anchor:h==c.line?c:l(h,0),head:h==e.line?e:l(h)});a.setSelections(d,0)};c["Shift-Tab"]="indentLess";e[c.Esc="singleSelectionTop"]=function(a){var b=a.listSelections()[0];a.setSelection(b.anchor,b.head,{scroll:!1})};e[c[g+"L"]="selectLine"]=function(a){for(var b=a.listSelections(),d=[],f=0;f<b.length;f++){var c=b[f];d.push({anchor:l(c.from().line,0),head:l(c.to().line+1,0)})}a.setSelections(d)};c["Shift-Ctrl-K"]="deleteLine";
e[c[g+"Enter"]="insertLineAfter"]=function(a){return u(a,!1)};e[c["Shift-"+g+"Enter"]="insertLineBefore"]=function(a){return u(a,!0)};e[c[g+"D"]="selectNextOccurrence"]=function(a){var b=a.getCursor("from"),d=a.getCursor("to"),f=a.state.sublimeFindFullWord==a.doc.sel;if(0==n.cmpPos(b,d)){f=r(a,b);if(!f.word)return;a.setSelection(f.from,f.to);f=!0}else b=a.getRange(b,d),b=f?new RegExp("\\b"+b+"\\b"):b,d=a.getSearchCursor(b,d),d.findNext()?a.addSelection(d.from(),d.to()):(d=a.getSearchCursor(b,l(a.firstLine(),
0)),d.findNext()&&a.addSelection(d.from(),d.to()));f&&(a.state.sublimeFindFullWord=a.doc.sel)};e[c["Shift-"+g+"Space"]="selectScope"]=function(a){v(a)||a.execCommand("selectAll")};e[c["Shift-"+g+"M"]="selectBetweenBrackets"]=function(a){if(!v(a))return n.Pass};e[c[g+"M"]="goToBracket"]=function(a){a.extendSelectionsBy(function(b){var d=a.scanForBracket(b.head,1);return d&&0!=n.cmpPos(d.pos,b.head)?d.pos:(d=a.scanForBracket(b.head,-1))&&l(d.pos.line,d.pos.ch+1)||b.head})};k=k?"Cmd-Ctrl-":"Shift-Ctrl-";
e[c[k+"Up"]="swapLineUp"]=function(a){if(a.isReadOnly())return n.Pass;for(var b=a.listSelections(),d=[],f=a.firstLine()-1,c=[],e=0;e<b.length;e++){var h=b[e],g=h.from().line-1,k=h.to().line;c.push({anchor:l(h.anchor.line-1,h.anchor.ch),head:l(h.head.line-1,h.head.ch)});0!=h.to().ch||h.empty()||--k;g>f?d.push(g,k):d.length&&(d[d.length-1]=k);f=k}a.operation(function(){for(var b=0;b<d.length;b+=2){var f=d[b],e=d[b+1],h=a.getLine(f);a.replaceRange("",l(f,0),l(f+1,0),"+swapLine");e>a.lastLine()?a.replaceRange("\n"+
h,l(a.lastLine()),null,"+swapLine"):a.replaceRange(h+"\n",l(e,0),null,"+swapLine")}a.setSelections(c);a.scrollIntoView()})};e[c[k+"Down"]="swapLineDown"]=function(a){if(a.isReadOnly())return n.Pass;for(var b=a.listSelections(),d=[],f=a.lastLine()+1,c=b.length-1;0<=c;c--){var e=b[c],h=e.to().line+1,g=e.from().line;0!=e.to().ch||e.empty()||h--;h<f?d.push(h,g):d.length&&(d[d.length-1]=g);f=g}a.operation(function(){for(var b=d.length-2;0<=b;b-=2){var c=d[b],f=d[b+1],e=a.getLine(c);c==a.lastLine()?a.replaceRange("",
l(c-1),l(c),"+swapLine"):a.replaceRange("",l(c,0),l(c+1,0),"+swapLine");a.replaceRange(e+"\n",l(f,0),null,"+swapLine")}a.scrollIntoView()})};e[c[g+"/"]="toggleCommentIndented"]=function(a){a.toggleComment({indent:!0})};e[c[g+"J"]="joinLines"]=function(a){for(var b=a.listSelections(),d=[],c=0;c<b.length;c++){for(var e=b[c],g=e.from(),h=g.line,k=e.to().line;c<b.length-1&&b[c+1].from().line==k;)k=b[++c].to().line;d.push({start:h,end:k,anchor:!e.empty()&&g})}a.operation(function(){for(var b=0,c=[],f=
0;f<d.length;f++){for(var e=d[f],g=e.anchor&&l(e.anchor.line-b,e.anchor.ch),h,k=e.start;k<=e.end;k++){var m=k-b;k==e.end&&(h=l(m,a.getLine(m).length+1));m<a.lastLine()&&(a.replaceRange(" ",l(m),l(m+1,/^\s*/.exec(a.getLine(m+1))[0].length)),++b)}c.push({anchor:g||h,head:h})}a.setSelections(c,0)})};e[c["Shift-"+g+"D"]="duplicateLine"]=function(a){a.operation(function(){for(var b=a.listSelections().length,d=0;d<b;d++){var c=a.listSelections()[d];c.empty()?a.replaceRange(a.getLine(c.head.line)+"\n",l(c.head.line,
0)):a.replaceRange(a.getRange(c.from(),c.to()),c.from())}a.scrollIntoView()})};c[g+"T"]="transposeChars";e[c.F9="sortLines"]=function(a){w(a,!0)};e[c[g+"F9"]="sortLinesInsensitive"]=function(a){w(a,!1)};e[c.F2="nextBookmark"]=function(a){var b=a.state.sublimeBookmarks;if(b)for(;b.length;){var d=b.shift(),c=d.find();if(c)return b.push(d),a.setSelection(c.from,c.to)}};e[c["Shift-F2"]="prevBookmark"]=function(a){var b=a.state.sublimeBookmarks;if(b)for(;b.length;){b.unshift(b.pop());var d=b[b.length-
1].find();if(d)return a.setSelection(d.from,d.to);b.pop()}};e[c[g+"F2"]="toggleBookmark"]=function(a){for(var b=a.listSelections(),d=a.state.sublimeBookmarks||(a.state.sublimeBookmarks=[]),c=0;c<b.length;c++){for(var e=b[c].from(),g=b[c].to(),h=a.findMarks(e,g),k=0;k<h.length;k++)if(h[k].sublimeBookmark){h[k].clear();for(var l=0;l<d.length;l++)d[l]==h[k]&&d.splice(l--,1);break}k==h.length&&d.push(a.markText(e,g,{sublimeBookmark:!0,clearWhenEmpty:!1}))}};e[c["Shift-"+g+"F2"]="clearBookmarks"]=function(a){if(a=
a.state.sublimeBookmarks)for(var b=0;b<a.length;b++)a[b].clear();a.length=0};e[c["Alt-F2"]="selectBookmarks"]=function(a){var b=a.state.sublimeBookmarks,d=[];if(b)for(var c=0;c<b.length;c++){var e=b[c].find();e?d.push({anchor:e.from,head:e.to}):b.splice(c--,0)}d.length&&a.setSelections(d,0)};c["Alt-Q"]="wrapLines";k=g+"K ";c[k+g+"Backspace"]="delLineLeft";e[c[k+g+"K"]="delLineRight"]=function(a){a.operation(function(){for(var b=a.listSelections(),d=b.length-1;0<=d;d--)a.replaceRange("",b[d].anchor,
l(b[d].to().line),"+delete");a.scrollIntoView()})};e[c[k+g+"U"]="upcaseAtCursor"]=function(a){x(a,function(a){return a.toUpperCase()})};e[c[k+g+"L"]="downcaseAtCursor"]=function(a){x(a,function(a){return a.toLowerCase()})};e[c[k+g+"Space"]="setSublimeMark"]=function(a){a.state.sublimeMark&&a.state.sublimeMark.clear();a.state.sublimeMark=a.setBookmark(a.getCursor())};e[c[k+g+"A"]="selectToSublimeMark"]=function(a){var b=a.state.sublimeMark&&a.state.sublimeMark.find();b&&a.setSelection(a.getCursor(),
b)};e[c[k+g+"W"]="deleteToSublimeMark"]=function(a){var b=a.state.sublimeMark&&a.state.sublimeMark.find();if(b){var d=a.getCursor();if(0<n.cmpPos(d,b)){var c=b;b=d;d=c}a.state.sublimeKilled=a.getRange(d,b);a.replaceRange("",d,b)}};e[c[k+g+"X"]="swapWithSublimeMark"]=function(a){var b=a.state.sublimeMark&&a.state.sublimeMark.find();b&&(a.state.sublimeMark.clear(),a.state.sublimeMark=a.setBookmark(a.getCursor()),a.setCursor(b))};e[c[k+g+"Y"]="sublimeYank"]=function(a){null!=a.state.sublimeKilled&&a.replaceSelection(a.state.sublimeKilled,
null,"paste")};c[k+g+"G"]="clearBookmarks";e[c[k+g+"C"]="showInCenter"]=function(a){var b=a.cursorCoords(null,"local");a.scrollTo(null,(b.top+b.bottom)/2-a.getScrollInfo().clientHeight/2)};e[c["Shift-Alt-Up"]="selectLinesUpward"]=function(a){a.operation(function(){for(var b=a.listSelections(),c=0;c<b.length;c++){var e=b[c];e.head.line>a.firstLine()&&a.addSelection(l(e.head.line-1,e.head.ch))}})};e[c["Shift-Alt-Down"]="selectLinesDownward"]=function(a){a.operation(function(){for(var b=a.listSelections(),
c=0;c<b.length;c++){var e=b[c];e.head.line<a.lastLine()&&a.addSelection(l(e.head.line+1,e.head.ch))}})};e[c[g+"F3"]="findUnder"]=function(a){z(a,!0)};e[c["Shift-"+g+"F3"]="findUnderPrevious"]=function(a){z(a,!1)};e[c["Alt-F3"]="findAllUnder"]=function(a){var b=y(a);if(b){for(var c=a.getSearchCursor(b.query),e=[],g=-1;c.findNext();)e.push({anchor:c.from(),head:c.to()}),c.from().line<=b.from.line&&c.from().ch<=b.from.ch&&g++;a.setSelections(e,g)}};c["Shift-"+g+"["]="fold";c["Shift-"+g+"]"]="unfold";
c[k+g+"0"]=c[k+g+"j"]="unfoldAll";c[g+"I"]="findIncremental";c["Shift-"+g+"I"]="findIncrementalReverse";c[g+"H"]="replace";c.F3="findNext";c["Shift-F3"]="findPrev";n.normalizeKeyMap(c)});